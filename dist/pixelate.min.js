"use strict";var _=_||{isObject:function(a){return a===Object(a)},isFunction:function(a){return!!(a&&a.constructor&&a.call&&a.apply)},isUndefined:function(a){return"undefined"==typeof a},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},isString:function(a){return"string"==typeof a||a instanceof String},defaults:function(a,b){var c,d={};for(c in a)d[c]=a[c];for(c in b)d[c]=b[c];return d},clone:function(a){return _.isObject(a)?_.isArray(a)?a.slice():_.extend({},a):a},each:function(a,b,c){if(null===a)return a;var d,e=0;if(Array.prototype.forEach&&a.forEach===Array.prototype.forEach)a.forEach(b,c);else if(a.length===+a.length){for(e=0,d=a.length;d>e;e++)if(b.call(c,a[e],e,a)==={})return}else{var f=_.keys(a);for(e=0,d=f.length;d>e;e++)if(b.call(c,a[f[e]],f[e],a)==={})return}return a},extend:function(a){return _.each(Array.prototype.slice.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a}},Backbone=Backbone||{triggerEvents:function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b);return}},eventsApi:function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(/\s+/.test(c)){for(var f=c.split(/\s+/),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},Events:{on:function(a,b,c){if(!Backbone.eventsApi(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},trigger:function(a){if(!this._events)return this;var b=Array.prototype.slice.call(arguments,1);if(!Backbone.eventsApi(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&Backbone.triggerEvents(c,b),d&&Backbone.triggerEvents(d,arguments),this}}};!function(a,b,c,d,e){function f(){this.initialize.apply(this,arguments)}var g={radius:10,selector:{masked:!0,strokeStyle:"black"},debug:!1},h=function(a,b,c,d){return a=a||0,b=b||0,c=c||0,d=d||0,{x:a,y:b,w:c,h:d,isEmpty:function(){return 0>=a&&0>=b&&0>=c&&0>=d},isValid:function(){return a!==e&&b!==e&&c!==e&&d!==e}}};h.EMPTY=h(0,0,0,0),c.extend(f.prototype,{VERSION:"0.1.0-@"}),c.extend(f.prototype,d.Events,{initialize:function(a,d){function e(a){i.originalCanvas=a,i.currentCanvas=a,i._$currentCanvas=b(i.currentCanvas),i._currentCanvasContext=i.currentCanvas.getContext("2d"),i._redraw(),i.initSelector(),i.initUISelector(),i.trigger("load")}this.options=c.defaults(d||{},g);var f,h,i=this;if(c.isString(a)){f=document.createElement("canvas"),h=f.getContext("2d");var j=new Image;j.onload=function(){f.width=j.width,f.height=j.height,b(f).width(j.width).height(j.height),h.drawImage(j,0,0,j.width,j.height),e(f)},j.src=a}else a.jquery&&(a=a[0]),"IMG"===a.nodeName?(f=document.createElement("canvas"),h=f.getContext("2d"),f.width=a.width,f.height=a.height,b(f).width(a.width).height(a.height),h.drawImage(a,0,0,a.width,a.height),b(a).replaceWith(f),e(f)):"CANVAS"===a.nodeName&&e(a)},update:function(a,d){var e=this.getSelectedArea(),f=b(a).width(),g=this._selectorCanvas.width,h=b(a).height(),i=this._selectorCanvas.height,j=f/g,k=f-g,l=h/i,m=h-i;this.currentCanvas=a,this._currentCanvasContext=this.currentCanvas.getContext("2d"),this._redraw(),c.extend(this.options,d||{}),this.updateSelector(),this.select(e.x+k/2,e.y+m/2,e.w*j,e.h*l)},pixelate:function(){var a=this.getSelectedArea(),b=this._pixelatedContext.getImageData(a.x+1,a.y+1,a.w-2,a.h-2);return this._currentCanvasContext.putImageData(b,a.x,a.y),this.clear(),this.trigger("pixelate",this.currentCanvas),this},dispose:function(){return this.disposeUISelector(),this.disposeSelector(),this.trigger("dispose"),this},_getClonedCanvas:function(a){var c=document.createElement("canvas"),d=c.getContext("2d");return c.width=a.width,c.height=a.height,b(c).width(b(a).width()),b(c).height(b(a).height()),d.drawImage(a,0,0),c},_redraw:function(){var a=this._getClonedCanvas(this.currentCanvas),c=b("<canvas></canvas>").attr("width",b(a).width()).attr("height",b(a).height())[0],d=c.getContext("2d");d.drawImage(a,0,0,a.width,a.height,0,0,b(a).width(),b(a).height()),this.currentCanvas.width=this._$currentCanvas.width(),this.currentCanvas.height=this._$currentCanvas.height(),this._currentCanvasContext.drawImage(c,0,0)}}),c.extend(f.prototype,{initSelector:function(){this._selectorCanvas=document.createElement("canvas"),this._$selectorCanvas=b(this._selectorCanvas),this._selectorContext=this._selectorCanvas.getContext("2d"),this._selectorContext.translate(.5,.5),this._selectorContext.setLineDash=this._selectorContext.setLineDash||function(){},this._selectorContext.strokeStyle=this.options.selector.strokeStyle,this._pixelatedCanvas=document.createElement("canvas"),this._pixelatedContext=this._pixelatedCanvas.getContext("2d"),this._pixelatedCanvas.width=b(this.currentCanvas).width(),this._pixelatedCanvas.height=b(this.currentCanvas).height(),this._pixelatedContext.mozImageSmoothingEnabled=!1,this._pixelatedContext.webkitImageSmoothingEnabled=!1,this._pixelatedContext.imageSmoothingEnabled=!1,this._masked=this.options.selector.masked,this._selectedArea=h.EMPTY,this._$currentCanvas.addClass("pixelate-src"),this._$currentCanvas.wrap('<div class="pixelate-parent"></div>'),this.$el=this._$currentCanvas.parent(),this._$selectorCanvas.addClass("pixelate-selector"),this._selectorCanvas.width=b(this.currentCanvas).width(),this._selectorCanvas.height=b(this.currentCanvas).height(),this._$currentCanvas.after(this._$selectorCanvas)},updateSelector:function(){this._masked=this.options.selector.masked,this._selectorCanvas.width=b(this.currentCanvas).width(),this._selectorCanvas.height=b(this.currentCanvas).height(),this._pixelatedCanvas.width=b(this.currentCanvas).width(),this._pixelatedCanvas.height=b(this.currentCanvas).height(),this._pixelatedContext.mozImageSmoothingEnabled=!1,this._pixelatedContext.webkitImageSmoothingEnabled=!1,this._pixelatedContext.imageSmoothingEnabled=!1},disposeSelector:function(){},select:function(a,b,c,d){return a=a||0,b=b||0,c=this.originalCanvas.width>a+c?c:this.originalCanvas.width-c,d=this.originalCanvas.height>b+d?d:this.originalCanvas.height-d,this.clear(),this.trigger("select:start",a,b),this.createSelectedArea(a,b,c,d),this.trigger("select:stop",a+c,b+d,this.getSelectedArea()),this.isMasked()&&this.pixelateSelectedArea(this.options.radius),this},move:function(a,b){a=a||0,b=b||0;var c=this.getSelectedArea();return this.createSelectedArea(c.x+a,c.y+b,c.w,c.h),this.isMasked()&&this.pixelateSelectedArea(),this.trigger("move",c.x+a,c.y+b),this},clear:function(){var a=this.getSelectedArea();return this.clearSelectedArea(),this.isMasked()&&this.clearPixelatedSelectedArea(),this.trigger("select:clear",a),this},createSelectedArea:function(a,b,c,d){var e=h(a,b,c,d);(e.isValid()||!e.isEmpty())&&(this.clearSelectedArea(),this._selectorContext.beginPath(),this._selectorContext.setLineDash([5,2]),this._selectorContext.rect(e.x,e.y,e.w,e.h),this._selectorContext.stroke(),this._selectedArea=e)},clearSelectedArea:function(){var a=this._selectedArea.x,b=this._selectedArea.y,c=this._selectedArea.w,d=this._selectedArea.h;this._selectorContext.clearRect(a-2,b-2,c+4,d+4),this._selectedArea=h.EMPTY},pixelateSelectedArea:function(a){a=a||this.options.radius,a=1>a?1:a>100?100:a;var c=this.getSelectedArea();if(c.isValid()&&!c.isEmpty()){var d=a/100,e=this.currentCanvas,f=e.width*d,g=e.height*d;if(this._pixelatedContext.drawImage(this.currentCanvas,0,0,f,g),this._pixelatedContext.drawImage(this._pixelatedCanvas,0,0,f,g,1,1,b(e).width(),b(e).height()),this.options.debug){var h=document.getElementById("debug-canvas"),i=h.getContext("2d");h.width=b(e).width(),h.height=b(e).height(),i.drawImage(this._pixelatedCanvas,0,0)}c.w=c.w-2<=0?c.w=3:c.w,c.h=c.h-2<=0?c.h=3:c.h,c.x+=1,c.y+=1;var j=this._pixelatedContext.getImageData(c.x+1,c.y+1,c.w-2,c.h-2);this._selectorContext.putImageData(j,c.x,c.y),this.trigger("mask",a,c)}},clearPixelatedSelectedArea:function(){var a=this._selectedArea.x,b=this._selectedArea.y,c=this._selectedArea.w,d=this._selectedArea.h;this._selectorContext.clearRect(a,b,c,d)},getSelectedArea:function(){return c.clone(this._selectedArea)},mask:function(a){return this.pixelateSelectedArea(a),this._masked=!0,this},unmask:function(){if(!this.isMasked())return this;var a=this.getSelectedArea();return this.clearPixelatedSelectedArea(),this._masked=!1,this.trigger("unmask",a),this},isMasked:function(){return this._masked}}),c.extend(f.prototype,{initUISelector:function(){this.enabled=!0,this.storage={mouseOn:"",resizeAt:"",border:4},this.mouse={startX:0,startY:0,endX:0,endY:0};var a=this,b=0,c=!1,d="",e=this.storage.border,f=this.storage.mouseOn;this._selectorCanvas.addEventListener("mousedown",function(e){if(a.enabled){d="down";var f=a._selectedArea,g=a._getMousePos(e);g.x>=f.x&&g.x<=f.x+f.w&&g.y>=f.y&&g.y<=f.y+f.h?c=!0:(c=!1,""===a.storage.resizeAt&&a.clearSelectedArea()),a._setMouseStart(g),a.trigger("select:start",g.x,g.y);var h=100;""!==a.storage.resizeAt&&(h=30),b=setTimeout(function(){d="hold"},h)}}),this._selectorCanvas.addEventListener("mouseup",function(){a.enabled&&(a.trigger("select:stop",a.mouse.endX,a.mouse.endY,a.getSelectedArea()),d="up",clearTimeout(b))});var g,h;this._selectorCanvas.addEventListener("mousemove",function(b){if(a.enabled)if(h=a._getMousePos(b),g=a._selectedArea,a.handleMouseCurrent(),"hold"===d){if(a._setMouseEnd(h),""!==a.storage.resizeAt)a.resizeSelectedArea();else if(c)a._moveSelectedArea();else{var i=a.mouse.startX>a.mouse.endX?a.mouse.endX:a.mouse.startX,j=a.mouse.startY>a.mouse.endY?a.mouse.endY:a.mouse.startY,k=Math.abs(a.mouse.startX-a.mouse.endX),l=Math.abs(a.mouse.startY-a.mouse.endY);a.createSelectedArea(i,j,k,l)}a.isMasked()&&a.pixelateSelectedArea(a.options.radius)}else 0!==g.w&&(f=h.x<g.x+e&&h.x>g.x-e?h.y<g.y+e&&h.y>g.y-e?"topLeft":h.y<g.y+g.h+e&&h.y>g.y+g.h-e?"bottomLeft":"left":h.x<g.x+g.w+e&&h.x>g.x+g.w-e?h.y<g.y+e&&h.y>g.y-e?"topRight":h.y<g.y+g.h+e&&h.y>g.y+g.h-e?"bottomRight":"right":h.y<g.y+e&&h.y>g.y-e?"top":h.y<g.y+g.h+e&&h.y>g.y+g.h-e?"bottom":h.x>g.x&&h.x<g.x+g.w&&h.y>g.y&&h.y<g.y+g.h?"center":"",a.storage.mouseOn=f)})},handleMouseCurrent:function(){var a=this.storage.mouseOn;this.storage.resizeAt=a,"right"===a||"left"===a?this._selectorCanvas.style.cursor="ew-resize":"top"===a||"bottom"===a?this._selectorCanvas.style.cursor="ns-resize":"topLeft"===a||"bottomRight"===a?this._selectorCanvas.style.cursor="nwse-resize":"topRight"===a||"bottomLeft"===a?this._selectorCanvas.style.cursor="nesw-resize":"center"===a?(this._selectorCanvas.style.cursor="move",this.storage.resizeAt=""):(this._selectorCanvas.style.cursor="crosshair",this.storage.resizeAt="")},resizeLeft:function(){var a=this._selectedArea,b=a.x+a.w-this.mouse.endX,c=this.mouse.endX;0>=b&&(c=a.x,b=this.mouse.endX-a.x),this.createSelectedArea(c,a.y,b,a.h)},resizeRight:function(){var a=this._selectedArea,b=this.mouse.endX-a.x;0>=b&&(b=a.x+a.w-this.mouse.endX,a.x=this.mouse.endX),this.createSelectedArea(a.x,a.y,b,a.h)},resizeTop:function(){var a=this._selectedArea,b=a.h+a.y-this.mouse.endY,c=this.mouse.endY;0>=b&&(c=a.y,b=this.mouse.endY-a.y),this.createSelectedArea(a.x,c,a.w,b)},resizeBottom:function(){var a=this._selectedArea,b=this.mouse.endY-a.y;0>=b&&(b=a.h+a.y-this.mouse.endY,a.y=this.mouse.endY),this.createSelectedArea(a.x,a.y,a.w,b)},resizeSelectedArea:function(){var a=this.storage.resizeAt;"bottom"===a?this.resizeBottom():"left"===a?this.resizeLeft():"right"===a?this.resizeRight():"top"===a?this.resizeTop():"topLeft"===a?(this.resizeLeft(),this.resizeTop()):"bottomLeft"===a?(this.resizeLeft(),this.resizeBottom()):"topRight"===a?(this.resizeRight(),this.resizeTop()):"bottomRight"===a&&(this.resizeRight(),this.resizeBottom())},enable:function(){this.enabled=!0,this._selectorCanvas.style.cursor="crosshair"},disable:function(){this.clear(),this.enabled=!1,this._selectorCanvas.style.cursor="auto"},_moveSelectedArea:function(){var a=this.mouse.endX-Math.floor(this._selectedArea.w/2),b=this.mouse.endY-Math.floor(this._selectedArea.h/2);this.createSelectedArea(a,b,this._selectedArea.w,this._selectedArea.h),this.trigger("move",a,b)},_getMousePos:function(a){var b=this._selectorCanvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}},_setMouseStart:function(a){this.mouse.startX=a.x,this.mouse.startY=a.y},_setMouseEnd:function(a){this.mouse.endX=a.x,this.mouse.endY=a.y},disposeUISelector:function(){}}),a.pixelate=function(a,b){return new f(a,b)}}(window,jQuery,_,Backbone);